/*
 * khelpers.c
 */

#include "khelpers.h"

/* functions resolved by init_kernel_help */
lNtAllocateVirtualMemory pNtAllocateVirtualMemory = NULL;
lNtCurrentTeb pNtCurrentTeb = NULL;
lNtQueryInformationProcess pNtQueryInformationProcess = NULL;
lNtQuerySystemInformation pNtQuerySystemInformation = NULL;

#ifdef DEBUGGING
void dprintf(char* pszFormat, ...)
{
	char s_acBuf[2048];
	va_list args;
	va_start(args, pszFormat);
	vsprintf_s(s_acBuf, sizeof(s_acBuf) - 1, pszFormat, args);
	printf(s_acBuf);
	printf("\n");
	va_end(args);
}
#endif

/*!
 * @brief Get the address of the win32k!tagSHAREDINFO in the current process.
 */
PHANDLEENTRY get_ahe_list(void)
{
	HMODULE hUser32 = NULL;
	PSHAREDINFO tagSharedInfo = NULL;

	hUser32 = LoadLibrary("user32");
	tagSharedInfo = (PSHAREDINFO)GetProcAddress(hUser32, "gSharedInfo");
	FreeLibrary(hUser32);
	if (tagSharedInfo == NULL) {
		return NULL;
	}
	return tagSharedInfo->aheList;
}

/*!
 * @brief Get the address of an object in the kernel from it's handle.
 * @param hHandle The handle to get the kernel address of.
 * @return The kernel address of the object associated with the handle.
 */
PVOID get_kernel_address(HANDLE hHandle)
{
	PULONG pTeb;
	PVOID pDeskInfo = NULL;
	ULONG ulClientDelta = 0;
	PVOID pKAddress = NULL;

	pTeb = pNtCurrentTeb();
	PHANDLEENTRY aheList = get_ahe_list();
	/* 441 = the offset for Windows 7 SP1 x86 */
	ulClientDelta = pTeb[441];

	PHANDLEENTRY target_handle = &aheList[((DWORD)hHandle & 0xffff)];
	pKAddress = target_handle->Head;
	pKAddress = (PVOID)((ULONG)pKAddress);
	return pKAddress;
}

/*!
 * @brief Initialize necessary things for kernel helper functions.
 */
BOOL init_kernel_help(void)
{
	HMODULE hNtdll = LoadLibrary("ntdll");
	BOOL bStatus = FALSE;

	do {
		if (hNtdll == NULL)
		{
			break;
		}

		pNtAllocateVirtualMemory = (lNtAllocateVirtualMemory)GetProcAddress(hNtdll, "NtAllocateVirtualMemory");
		if (pNtAllocateVirtualMemory == NULL)
		{
			break;
		}

		pNtCurrentTeb = (lNtCurrentTeb)GetProcAddress(hNtdll, "NtCurrentTeb");
		if (pNtCurrentTeb == NULL)
		{
			break;
		}

		pNtQueryInformationProcess = (lNtQueryInformationProcess)GetProcAddress(hNtdll, "NtQueryInformationProcess");
		if (pNtQueryInformationProcess == NULL)
		{
			break;
		}

		pNtQuerySystemInformation = (lNtQuerySystemInformation)GetProcAddress(hNtdll, "ZwQuerySystemInformation");
		if (pNtQuerySystemInformation == NULL)
		{
			break;
		}

		bStatus = TRUE;
	} while (FALSE);

	FreeLibrary(hNtdll);
	return bStatus;
}
